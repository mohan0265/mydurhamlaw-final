const { Document, Packer, Paragraph, TextRun, AlignmentType, HeadingLevel } = require('docx');

exports.handler = async (event) => {
  // Handle GET requests for downloading
  if (event.httpMethod === 'GET') {
    try {
      const encodedData = event.queryStringParameters?.data;
      
      if (!encodedData) {
        return {
          statusCode: 400,
          body: 'Missing download data'
        };
      }

      // Decode from base64
      const jsonString = Buffer.from(encodedData, 'base64').toString('utf-8');
      const { assignment, finalDraft, aiUsageLog } = JSON.parse(jsonString);

      if (!finalDraft) {
        return {
          statusCode: 400,
          body: 'No draft content in download data'
        };
      }

      // Generate document
      const paragraphs = finalDraft
        .split(/\n+/)
        .map(p => p.trim())
        .filter(p => p.length > 0);

      const doc = new Document({
        creator: "MyDurhamLaw",
        title: assignment.module_name || "Law Assignment",
        description: "Generated by MyDurhamLaw Assignment Assistant",
        sections: [{
          properties: {},
          children: [
            new Paragraph({
              text: assignment.module_code || "LAW MODULE",
              heading: HeadingLevel.HEADING_1,
              alignment: AlignmentType.CENTER,
              spacing: { before: 400, after: 200 },
            }),
            new Paragraph({
              text: assignment.module_name || "Law Assignment",
              alignment: AlignmentType.CENTER,
              spacing: { after: 400 },
            }),
            new Paragraph({
              text: `Word Count: ${finalDraft.trim().split(/\s+/).length} words`,
              alignment: AlignmentType.CENTER,
              spacing: { after: 200 },
            }),
            new Paragraph({
              text: `Deadline: ${assignment.due_date || 'Not specified'}`,
              alignment: AlignmentType.CENTER,
              spacing: { after: 400 },
            }),
            new Paragraph({ text: "", pageBreakBefore: true }),
            
            ...paragraphs.map(para => 
              new Paragraph({
                children: [new TextRun({ text: para, font: "Times New Roman", size: 24 })],
                spacing: { before: 120, after: 120 },
                alignment: AlignmentType.JUSTIFIED,
              })
            ),
            
            new Paragraph({ text: "", pageBreakBefore: true }),
            new Paragraph({
              text: "Academic Integrity Declaration",
              heading: HeadingLevel.HEADING_2,
              spacing: { before: 400, after: 200 },
            }),
            new Paragraph({
              text: "In accordance with Durham Law School's Generative AI Policy (2025-26), the following AI assistance was used in preparing this assignment:",
              spacing: { after: 200 },
            }),
            ...(aiUsageLog || []).map((log, idx) => 
              new Paragraph({
                text: `${idx + 1}. ${log}`,
                spacing: { before: 60, after: 60 },
              })
            ),
            new Paragraph({
              children: [new TextRun({ 
                text: "All substantive content and analysis is the student's original work. AI tools were used only for permitted purposes as outlined in the assessment guidelines. The student takes full responsibility for the accuracy of all content.",
                italics: true,
              })],
              spacing: { before: 200, after: 200 },
            }),
          ],
        }],
      });

      const buffer = await Packer.toBuffer(doc);
      const filename = `${assignment.module_code || 'Assignment'}_${(assignment.title || 'Document').replace(/\s+/g, '_')}.docx`;

      return {
        statusCode: 200,
        headers: {
          'Content-Type': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
          'Content-Disposition': `attachment; filename="${filename}"`,
          'Content-Length': buffer.length.toString(),
          'Cache-Control': 'no-cache, no-store, must-revalidate',
        },
        body: buffer.toString('base64'),
        isBase64Encoded: true,
      };
    } catch (error) {
      console.error('Error generating document:', error);
      return {
        statusCode: 500,
        body: `Error: ${error.message}`
      };
    }
  }

  return { statusCode: 405, body: 'Method Not Allowed' };
};
